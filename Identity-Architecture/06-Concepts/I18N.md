# I18N

## 定義
在本專案中，「i18n / 多語系」主要指的是：
- **決定每個 Request 的 Culture / UI Culture**（影響日期/數字格式、資源字串選擇）
- **提供 UI 文案的來源**（resx / IStringLocalizer / DataAnnotations，以及 DB 治理型多語字串）

ASP.NET Core 的核心機制是 `RequestLocalizationMiddleware`：
- 會在每個 request 早期，根據 culture provider 的決策結果設定：
  - `CultureInfo.CurrentCulture`
  - `CultureInfo.CurrentUICulture`

---

## ASP.NET Core 機制（本專案採用）

### 1) 啟用 Localization 與 RequestLocalization
各 MVC 站台（PMS / Trade / DataAdmin / SSO / PMS.Sewing）都有：
- `builder.Services.AddLocalization(...)`
- `builder.Services.Configure<RequestLocalizationOptions>(...)`
- `app.UseRequestLocalization(...)`

> 注意：本 repo 站台多半把 `UseRequestLocalization(...)` 放在 pipeline 很前面（甚至標註「一定要最先」），以確保後續 middleware / controller 拿到的是正確的 `CurrentUICulture`。

### 2) Culture 決策來源（Providers）
ASP.NET Core 的 culture 決策通常可能來自：
- Cookie（`.AspNetCore.Culture`）
- Query string
- Accept-Language header

本 repo 的站台差異點在於：
- **ERP.Trade / ERP.DataAdmin**：明確只保留 `CookieRequestCultureProvider`（只吃 cookie，不看 Accept-Language / Query）
- **ERP.PMS / ERP.PMS.Sewing / ERP.SSO**：未見到把 provider 限縮為 cookie-only（以預設 provider 集合為主，實際仍會優先看 cookie）

---

## `.AspNetCore.Culture` Cookie（切換語系的關鍵）

### Cookie 名稱與格式
- Cookie 名稱：`CookieRequestCultureProvider.DefaultCookieName`（預設就是 `.AspNetCore.Culture`）
- Cookie 值格式：`c=<culture>|uic=<culture>`

### 寫入點（本 repo 觀察到的三種模式）

#### A) MVC Controller 寫入（標準做法）
- `ERP.Trade/Controllers/LanguageController.cs`：`/Language/SetLanguage?culture=...&returnUrl=...`
- `ERP.DataAdmin/Controllers/LanguageController.cs`：`/Language/SetLanguage?culture=...&returnUrl=...`
- `ERP.SSO/Controllers/CultureController.cs`：`POST /Culture/SetLanguage`

這些 action 的核心都一致：
- `Response.Cookies.Append(CookieRequestCultureProvider.DefaultCookieName, MakeCookieValue(new RequestCulture(culture)), ...)`
- Redirect 回原頁，確保後續 request 重新進入 pipeline。

#### B) 前端 JS 直接寫入
- `ERP.PMS/wwwroot/js/login/login.js` 會直接寫：
  - `document.cookie = ".AspNetCore.Culture=c=${selectedLanguage}|uic=${selectedLanguage}; path=/;";`

#### C) 其他「使用者偏好」cookie（非 ASP.NET Core 標準 culture cookie）
- `ERP.CommonLib/Services/Session/UserPreferenceService.cs` 會用 `UserPreference` cookie 保存 `C=<culture>&T=<timezone>`

> 這個 `UserPreference` cookie **不是** `RequestLocalizationMiddleware` 預設會讀的格式。
> 若要讓它真的影響 `CurrentCulture/CurrentUICulture`，需要自訂 `IRequestCultureProvider` 或在 pipeline 中自行寫入 `.AspNetCore.Culture`。

---

## 支援語系清單（SupportedCultures）
各站台會在 `RequestLocalizationOptions` 設定支援語系與 Default culture。
本 repo 可觀察到的差異：
- **ERP.Trade / ERP.DataAdmin**：`zh-TW`, `zh-CN`, `en-US`, `vi-VN`, `km-KH`, `tl-PH`，Default `zh-TW`，且 cookie-only provider
- **ERP.SSO**：`en`, `zh-TW`, `zh-CN`, `vi`, `km`, `fil`，Default `en`
- **ERP.PMS / ERP.PMS.Sewing**：偏向 `en`, `zh-TW`, `zh-CN`, `ja`，Default `zh-TW`

> 注意：同一語言可能在不同站台使用不同 culture code（例如 `vi` vs `vi-VN`）。如果有跨站台共享的 culture cookie，需要確認是否會造成「站台 A 設 vi，站台 B 不認得」的問題。

---

## 字串來源：resx vs DB 治理型多語

### A) resx（IStringLocalizer / IViewLocalizer / DataAnnotations）
典型特徵：
- 站台會在 MVC 設定上加：
  - `.AddViewLocalization(...)`
  - `.AddDataAnnotationsLocalization()`
- SSO 也有 `AddLocalization(o => o.ResourcesPath = "Resources")`

此路徑適合：
- View 文案（Razor）
- DataAnnotations 驗證訊息、欄位顯示名

### B) DB 治理型多語（LngDbContext + LocalizationService）
CommonLib 提供集中治理服務：
- `ERP.CommonLib/Data/LngDbContext.cs`：Lng* 資料表（語言清單、通用字串、Menu、Enum、TableField...）
- `ERP.CommonLib/Services/Localization/LocalizationService.cs`：查詢 + Fallback（指定 culture → 預設 culture）

它不是 `IStringLocalizer` 的同義替代，而是「系統治理層」：
- 可由後台維護（資料表）
- 可統一 fallback 與啟用狀態（IsEnabled）
- 可支援 Menu / Enum / 欄位標題等「非 View 資源」

### DB 多語對外的 API（WebAPI.DataAdmin）
- `ERP.WebAPI.DataAdmin` 會註冊 `ILocalizationService` → `LocalizationService`
- 並提供 `.../localization/*` 的查詢端點（Controller 只做轉發，治理邏輯都在 service）

---

## 端到端資料流（本 repo 典型）

### Flow 1：使用者切換語系（MVC）
1. 使用者點語系切換 → 呼叫 `LanguageController.SetLanguage(...)` 或 `CultureController.SetLanguage(...)`
2. Server 寫入 `.AspNetCore.Culture` cookie
3. Redirect 回原頁
4. 下一次 request：`UseRequestLocalization(...)` 讀 cookie → 設定 `CurrentCulture/CurrentUICulture`
5. 後續 View / Validation / Localizer 根據 `CurrentUICulture` 選擇字串

### Flow 2：前端從 WebAPI 拉 DB 多語字典
1. Browser 端帶著 `.AspNetCore.Culture`（決定 UI）與 `AuthToken`（決定身份）
2. MVC 站台透過 `IApiDataServiceV2/ApiCaller` 等呼叫 WebAPI.DataAdmin 的 localization API
3. WebAPI 透過 `LocalizationService` + `LngDbContext` 查 DB，按 culture + fallback 回傳字典
4. 前端把字典用於：選單、欄位標題、列舉顯示、匯出欄位翻譯等

---

## 常見坑（排查方向）
- 站台把 `RequestCultureProviders` 限縮為 cookie-only → Accept-Language 永遠不生效
- 不同站台 culture code 不一致（`vi` vs `vi-VN`）→ cookie 設了但另一站台不認
- 前端用 JS 寫 cookie 沒設 Expires → session cookie，關瀏覽器後消失
- DB 治理多語與 resx 同時存在 → 需要明確定義「哪種 UI 字串走哪條管道」
